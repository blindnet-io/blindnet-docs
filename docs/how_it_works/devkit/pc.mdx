# How Privacy Compiler Works

## Initial Set-up

Based on the [configuration given to the Privacy Computation Engine](./pce.mdx#configuring-your-privacy-computation-engine), the Privacy Compiler first calculates an initial Eligible Privacy Scope.

In the Eligible Privacy Scope, each [Privacy Scope Triple](#triple) is associated with one or more active [Legal Bases](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#legal-base).
Legal Bases can be acquired and lost.
[Privacy Scope Triples](#triple) stay in the Eligible Privacy Scope as long as they have at least one active Legal Base associated to them.

Initially, before the user gave any consent or signed any contract (subscribed to any service, opened any account) the Eligible Privacy Scope consists of Privacy Scope Triples associated with `LEGITIMATE-INTEREST`, or `NECESSARY` Legal Bases.

Privacy Compiler also know of combinations of Privacy Scope Triples and Legal Bases that are prohibited under certain legislations (e.g. under GDPR certain data can only be processed with `CONSENT`).
Such combinations can't enter the Eligible Privacy Scope.

## Processing PRIV Events

With every PRIV event, the Privacy Compiler calculated the change to be made to the Eligible Privacy Scope.

### Consent

The Eligible Privacy Scope becomes the [union](#union) of the previous Eligible Privacy Scope and of the Privacy Scope given in the `scope` property of the [Consent](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#consent).

### Legal Base Event

For events of `event-type` `SERVICE-START` or `RELATIONSHIP-START`:
- the `scope` of the [Legal Base](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#legal-base) is added to the Eligible Privacy Scope using the [union](#union) operation.
- when a `data-reference` is specified in the [Legal Base Event](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#legal-base-event) the Privacy Compiler remembers it so that Triples associated to this reference can be found later

For events of `event-type` `SERVICE-END` or `RELATIONSHIP-END`:
- when a particular `data-reference` is given:
    > **Note**
    > A Data reference can indicate a particular user account, contract, particular medical or legal file especially when the same Data Subject may have several ongoing files with the same Organization
    - The Privacy Compiler looks for Triples in the Eligible Privacy Scope that have that reference
    - Removes the reference and to it associated Legal Base
    - Removes from the Eligible Privacy Scope all the Triples that are left with no active Legal Base
- when no `data-reference` is given:
    - The Privacy Compiler looks for all Triples associated with the `legal-base` of the Legal Base Event
    - Removes the Legal Base in question
    - Removes from the Eligible Privacy Scope all the Triples that are left with no active Legal Base

### `REVOKE-CONSENT` Privacy Requests

The Privacy Compiler looks for the [Consent Restriction](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#consent-restriction) associated with the [Privacy Request](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#privacy-request).
It retrieves `consent-ids` from it.
Then, Privacy Compiler finds all the Triples associated to those consents, and removes those associations.
Finally, it removes from the Eligible Privacy Scope all the Triples that are left with no active Legal Base as a consequence of consent removal.

Alternatively, `REVOKE-CONSENT` Privacy Requests can be associated with a [Privacy Scope Restriction](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#privacy-scope).
In this case, the Privacy Compiler alters all existing Consents.
The `scope` of every consent is replaced by the [intersection](#intersection) of the previous scope and of the Privacy Scope of the Privacy Scope Restriction of the Request.
As a result, new Consents are made and old ones removed.
Finally, the Privacy Compiler removes all the Triples that are left with no active Legal Base ([intersection](#intersection) operation) as a consequence of consent change.
See [Operations over Consents](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/expected-behavior.md#operations-over-consents) for more details.

### `OBJECT` Privacy Requests
The Privacy Compiler looks for a [Privacy Scope Restriction](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#privacy-scope) associated with the request.
It removes from the from the Eligible Privacy Scope all the Triples found in the [intersection](#intersection) of the Eligible Privacy Scope and the scope of the given Privacy Scope Restriction.
The removal does not apply to Triples associated with `NECESSARY` or `CONTRACT` Legal Bases.

If there are any Consents, the Privacy Compiler proceeds with them the same way as with `REVOKE-CONSENT` Privacy Requests associated to a Privacy Scope Restriction.
See [Operations over Consents](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/expected-behavior.md#operations-over-consents) for more details.

### `RESTRICT` Privacy Requests
The Privacy Compiler looks for a [Privacy Scope Restriction](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#privacy-scope) associated with the request.
The Eligible Privacy Scope becomes the [intersection](#intersection) of the Eligible Privacy Scope and the scope of the given Privacy Scope Restriction.
The trimming of Eligible Privacy Scope does not apply to Triples associated with `NECESSARY` or `CONTRACT` Legal Bases.

If there are any Consents, the Privacy Compiler changes them to only leave the parts of their scopes found in the [intersection](#intersection) of the Eligible Privacy Scope and the scope of the given Privacy Scope Restriction.
See [Operations over Consents](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/expected-behavior.md#operations-over-consents) for more details.


## Privacy Algebra

### Privacy Scope Triples

A **<a name="triple"></a>Privacy Scope Triple** is a unit of [Privacy Scope](RFC-PRIV.md#privacy-scope)
and it consists of (in that order):
- one [Data Category Term](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/./https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#data-categories) or `*`
- one [Processing Category Term](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#processing-categories) or `*`
- one [Purpose Term](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#purpose) or `*`

When `*` is indicated at one of the places of the triple, it is interpreted as all [Data Categores](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#data-categories), all [Processing Categories](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#processing-categories) or all [Purposes](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#purpose) depending on its place in the triple.

### Operations Over Privacy Scopes

#### Equivalence

Each Privacy Scope Triple that has a `*` or a [Term](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#terms) of which subcategory terms are known (including [Data Capture Fragment](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#data-capture-fragments) `selectors` for [Data Category Terms](https://github.com/blindnet-io/product-management/blob/main/refs/schemas/priv/RFC-PRIV.md#data-categories)) is equivalent to the set of Privacy Scope Triples including all combinations of such known subcategories (or all categories in case of `*`).

E.g. `FINANCIAL` x `SHARING` x `SERVICES` is equivalent to the following set:

`FINANCIAL` x `SHARING` x `SERVICES`
`FINANCIAL` x `SHARING` x `SERVICES.ADDITIONAL-SERVICES`
`FINANCIAL` x `SHARING` x `SERVICES.BASIC-SERVICE`
`FINANCIAL.BANK-ACCOUNT` x `SHARING` x `SERVICES`
`FINANCIAL.BANK-ACCOUNT` x `SHARING` x `SERVICES.ADDITIONAL-SERVICES`
`FINANCIAL.BANK-ACCOUNT` x `SHARING` x `SERVICES.BASIC-SERVICE`

If the System also knows of a `selector` `FINANCIAL.BANK-ACCOUNT.PRIMARY`, then the equivalent set also includes:

`FINANCIAL.BANK-ACCOUNT.PRIMARY` x `SHARING` x `SERVICES`
`FINANCIAL.BANK-ACCOUNT.PRIMARY` x `SHARING` x `SERVICES.ADDITIONAL-SERVICES`
`FINANCIAL.BANK-ACCOUNT.PRIMARY` x `SHARING` x `SERVICES.BASIC-SERVICE`

#### Inclusion

Privacy Scope A is included in Privacy Scope B if all the Privacy Scope Triples from Privacy Scope B, and their equivalents, can be found among Privacy Scope Triples of the Privacy Scope A or their equivalents.

#### Union

The Union of Privacy Scopes A and B includes all Privacy Scope Triples (and their equivalents) from Privacy Scopes A and B.

#### Intersection

The Union of Privacy Scopes A and B includes all Privacy Scope Triples (and their equivalents) that can be found among Privacy Scope Triples (or their equivalents) of both Privacy Scopes A and B.
